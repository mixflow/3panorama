/*
 * A panorama viewer base on three.js.
 * Panarama is a type of image which can be watched in 360 degree horizonally and 180 degree vertically.
 *
 * @license Apache 2.0
 * @author MixFlow
 * @date 2017-08
 */
(function(){var e=[].slice;window.threePanorama=function(n){var t,i,r,o,a,u,l,c,s,d,m,h,f,g,w,v,M,E,p,x,y,T,D,z,b,I,N,R,S,C;l={container:document.body,image:void 0,fov:65,canUseWindowSize:!1,alternateRatio:16/9,canKeepInitalSize:!0,enableDragNewImage:!0,mouseSensitivity:.1,enableDeviceOrientation:!0,lonlat:[0,0],sphere:{radius:500},debug:{imageLoadProgress:!1,lonlat:!1,cameraSize:!1}},n=n||{};for(w in l)S=l[w],w in n||(n[w]=S);if(null==n.image)throw{type:"No image provided.",msg:"Please fill panorama image path(string) in the parameter 'image' of settings"};return a="string"==typeof n.container?document.querySelectorAll(n.container)[0]:n.container,M=n.lonlat[0],v=n.lonlat[1],C=0,m=0,x={},(d=function(e){var t;if(null==e&&(e=n.canKeepInitalSize),n.canUseWindowSize?(C=window.innerWidth,m=window.innerHeight):(t=a.getBoundingClientRect(),C=t.width,m=t.height),!C&&!m)throw{type:"Lack of Viewer Size.",msg:"Viewer width and height are both missing(value is 0), Please check the container size(width and height > 0). Or use window size to set Viewer size by setting `canUseWindowSize` as `true`"};return m?C||(C=m*n.alternateRatio):m=C/n.alternateRatio,!0===e&&(C in x?m=x[C]:x[C]=m),n.debug.cameraSize&&console.log("current camera size:",C,m),{width:C,height:m}})(),R=function(){var n,t;return n={addClass:function(e,n){return e.className+=" "+n},removeClass:function(e,n){return e.className=e.className.replace(new RegExp("(\\s|^)"+n+"(\\s|$)"),"")},on:function(e,n,t,i){var r,o,a,u,l;for(null==i&&(i=!1),l=[],a=0,u=(o=n.split(" ")).length;a<u;a++)r=o[a],l.push(e.addEventListener(r,t,i));return l},off:function(e,n,t,i){var r,o,a,u,l;for(null==i&&(i=!1),l=[],a=0,u=(o=n.split(" ")).length;a<u;a++)r=o[a],l.push(e.removeEventListener(r,t,i));return l}},t=function(t){var i,r,o;o=function(n){return function(){var i;return i=1<=arguments.length?e.call(arguments,0):[],n.apply(null,[t.domel].concat(e.call(i))),t}};for(r in n)i=n[r],t[r]=o(i);return t},function(e){var i;return null!=e?(i={domel:e},t(i)):n}}(),h=function(){var e,t,r,o,u,l,c;return e=new THREE.PerspectiveCamera(n.fov,C/m,1,1100),e.target=new THREE.Vector3(0,0,0),(t=new THREE.SphereBufferGeometry(n.sphere.radius,50,50)).scale(-1,1,1),c=(new THREE.TextureLoader).load(n.image),r=new THREE.MeshBasicMaterial({map:c}),o=new THREE.Mesh(t,r),(l=new THREE.Scene).add(o),u=g(),a.appendChild(u.domElement),i(u.domElement),f(a),R(window).on("resize",function(){var e;return e=void 0,function(n){return clearTimeout(e),e=setTimeout(function(){return p(n,!1)},100)}}(),!1),{camera:e,mesh:o,scene:l,renderer:u}},g=function(){var e;return(e=new THREE.WebGLRenderer).setPixelRatio(window.devicePixelRatio),e.setSize(C,m),e},i=function(e){var t,i,r,o,a,u,l,c,s,d,m,h,f,g,w;return u=0,l=0,a=0,o=0,c=!1,r=function(e){return function(n){return n.preventDefault(),c=!0,u=e?n.changedTouches[0].clientX:n.clientX,l=e?n.changedTouches[0].clientY:n.clientY,a=M,o=v}},i=function(e){return function(t){var i,r,s;if(!0===c&&(r=e?t.changedTouches[0].clientX:t.clientX,s=e?t.changedTouches[0].clientY:t.clientY,i=n.mouseSensitivity,M=(u-r)*i+a,v=(s-l)*i+o,n.debug.lonlat))return console.log("longitude: ",M,"latitude: ",v)}},t=function(e){return c=!1},s=r(!1),d=i(!1),m=t,(h=R(e)).on("mousedown",s,!1).on("mousemove",d,!1).on("mouseup",m,!1),w=r(!0),g=i(!0),f=t,h.on("touchstart",w,!1).on("touchmove",g,!1).on("touchend",f,!1)},s=function(e){return null==e&&(e=document),function(){return e.fullscreenElement||e.webkitFullscreenElement||e.mozFullScreenElement||e.msFullscreenElement}},c=s(),D=function(){var e,n;return document.exitFullscreen?(e=function(){return document.exitFullscreen()},n=function(e){return e.requestFullscreen()}):document.msExitFullscreen?(e=function(){return document.msExitFullscreen()},n=function(e){return e.msRequestFullscreen()}):document.mozCancelFullScreen?(e=function(){return document.mozCancelFullScreen()},n=function(e){return e.mozRequestFullscreen()}):document.webkitExitFullscreen?(e=function(){return document.webkitExitFullscreen()},n=function(e){return e.webkitRequestFullscreen()}):n=e=function(){return console.log("The bowser doesn't support fullscreen mode")},{request:n,exit:e}},b=function(){var e,n,t;return n=D(),t=n.request,e=n.exit,function(n){return c()?e():t(n)}}(),o=function(e){var n,t,i;return t=c(),n="fullscreen-mode",i=R(e),null!=t?(i.addClass(n),e.style.width="100vw",e.style.height="100vh",e.style["max-width"]="unset",e.style["max-height"]="unset"):(i.removeClass(n),e.style.width=null,e.style.height=null,e.style["max-width"]=null,e.style["max-height"]=null)},f=function(e){var t,i,r;return t=document.createElement("div"),t.className="3panorama-controls",t.style.position="absolute",t.style.bottom=0,t.style.width="100%",t.style.height="3.5em",t.style["min-height"]="32px",i=document.createElement("img"),r=R(i),i.src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMjAgMzIwIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiPiAgPHBhdGggZmlsbD0iIzVhOWNmYyIgZD0iTTEyNSAxODAuODVsLTEwNSAxMDVWMjAzLjRIMFYzMjBoMTE2LjZ2LTIwSDM0LjE0bDEwNS4wMS0xMDV6TTIwMy40IDB2MjBoODIuNDZMMTgwLjg1IDEyNWwxNC4xNCAxNC4xNUwzMDAgMzQuMTR2ODIuNDZoMjBWMHoiLz4gIDxwYXRoIGZpbGw9IiNGRkYiIGQ9Ik0yMCAzNC4xNGwxMDUgMTA1IDE0LjE1LTE0LjEzTDM0LjE1IDIwaDgyLjQ1VjBIMHYxMTYuNmgyMHpNMzAwIDI4NS44NkwxOTUgMTgwLjg1bC0xNC4xNSAxNC4xNEwyODUuODYgMzAwSDIwMy40djIwSDMyMFYyMDMuNGgtMjB6Ii8+PC9zdmc+",i.style.margin="0.3em",i.style.height="75%",i.style["min-height"]="24px",r.on("click",function(){return b(e)},!1),R(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange msfullscreenchange",function(){return o(e)}),t.appendChild(i),function(){var e,i,r;i=document.createElement("div"),r=R(i),i.innerText="Enable Sensor: ",i.style.display="inline",i.style.color="#FFF",i.style["font-size"]="1em",i.style["text-stroke"]="0.2px #5a9cfc",i.style["-webkit-text-stroke"]="0.2px #5a9cfc",e=document.createElement("span"),e.innerText=n.enableDeviceOrientation?"On":"Off",i.appendChild(e),r.on("click",function(){return n.enableDeviceOrientation=!n.enableDeviceOrientation,n.enableDeviceOrientation?e.innerText="On":e.innerText="Off"},!1),t.appendChild(i)}(),e.appendChild(t)},function(){var e;return e=function(){var e,t;return e=void 0,t=void 0,function(i){var r,o;return n.enableDeviceOrientation?(r=i.alpha,o=i.beta,null!=e&&(M+=r-e,v+=o-t),e=r,t=o):(e=void 0,t=void 0)}}(),R().on(window,"deviceorientation",e,!0)}(),p=function(e,n){return null==n&&(n=!0),d(n),r.aspect=C/m,r.updateProjectionMatrix(),T.setSize(C,m)},y=h(),r=y.camera,E=y.mesh,z=y.scene,T=y.renderer,t=function(){requestAnimationFrame(t),I()},I=function(){return N(),T.render(z,r)},N=function(){var e,t,i,o,a,u;return v=Math.max(-85,Math.min(85,v)),e=THREE.Math.degToRad(90-v),i=THREE.Math.degToRad(M),t=n.sphere.radius,o=t*Math.sin(e)*Math.cos(i),a=t*Math.cos(e),u=t*Math.sin(e)*Math.sin(i),r.lookAt(new THREE.Vector3(o,a,u))},t(),u=n.debug,{container:a,camera:r,mesh:E,scene:z,renderer:T,debugSettings:u,util:R}}}).call(this);