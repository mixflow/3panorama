/*
 * A panorama viewer base on three.js.
 * Panarama is a type of image which can be watched in 360 degree horizonally and 180 degree vertically.
 *
 * @license Apache 2.0
 * @author MixFlow
 * @date 2017-08
 */
(function(){var e=[].slice;window.threePanorama=function(n){var t,i,r,o,c,u,l,a,s,g,d,m,M,w,h,I,C,f,x,D,E,A,L,v,y,z,T,b,j,p;l={container:document.body,image:void 0,fov:65,canUseWindowSize:!1,alternateRatio:16/9,canKeepInitalSize:!0,enableDragNewImage:!0,mouseSensitivity:.1,lonlat:[0,0],sphere:{radius:500},debug:{imageLoadProgress:!1,lonlat:!1,cameraSize:!1}},n=n||{};for(h in l)j=l[h],h in n||(n[h]=j);if(null==n.image)throw{type:"No image provided.",msg:"Please fill panorama image path(string) in the parameter 'image' of settings"};return c="string"==typeof n.container?document.querySelectorAll(n.container)[0]:n.container,C=n.lonlat[0],I=n.lonlat[1],p=0,d=0,D={},(g=function(e){var t;if(null==e&&(e=n.canKeepInitalSize),n.canUseWindowSize?(p=window.innerWidth,d=window.innerHeight):(t=c.getBoundingClientRect(),p=t.width,d=t.height),!p&&!d)throw{type:"Lack of Viewer Size.",msg:"Viewer width and height are both missing(value is 0), Please check the container size(width and height > 0). Or use window size to set Viewer size by setting `canUseWindowSize` as `true`"};return d?p||(p=d*n.alternateRatio):d=p/n.alternateRatio,!0===e&&(p in D?d=D[p]:D[p]=d),n.debug.cameraSize&&console.log("current camera size:",p,d),{width:p,height:d}})(),b=function(){var n,t;return n={addClass:function(e,n){return e.className+=" "+n},removeClass:function(e,n){return e.className=e.className.replace(new RegExp("(\\s|^)"+n+"(\\s|$)"),"")},on:function(e,n,t,i){var r,o,c,u,l;for(null==i&&(i=!1),l=[],c=0,u=(o=n.split(" ")).length;c<u;c++)r=o[c],l.push(e.addEventListener(r,t,i));return l}},t=function(t){var i,r,o;o=function(n){return function(){var i;return i=1<=arguments.length?e.call(arguments,0):[],n.apply(null,[t.domel].concat(e.call(i))),t}};for(r in n)i=n[r],t[r]=o(i);return t},function(e){var i;return null!=e?(i={domel:e},t(i)):n}}(),m=function(){var e,t,r,o,u,l,a;return e=new THREE.PerspectiveCamera(n.fov,p/d,1,1100),e.target=new THREE.Vector3(0,0,0),(t=new THREE.SphereBufferGeometry(n.sphere.radius,50,50)).scale(-1,1,1),a=(new THREE.TextureLoader).load(n.image),r=new THREE.MeshBasicMaterial({map:a}),o=new THREE.Mesh(t,r),(l=new THREE.Scene).add(o),u=w(),c.appendChild(u.domElement),i(u.domElement),M(c),b(window).on("resize",x,!1),{camera:e,mesh:o,scene:l,renderer:u}},w=function(){var e;return(e=new THREE.WebGLRenderer).setPixelRatio(window.devicePixelRatio),e.setSize(p,d),e},i=function(e){var t,i,r,o,c,u,l,a,s,g,d,m,M,w,h;return u=0,l=0,c=0,o=0,a=!1,r=function(e){return function(n){return n.preventDefault(),a=!0,u=e?n.changedTouches[0].clientX:n.clientX,l=e?n.changedTouches[0].clientY:n.clientY,c=C,o=I}},i=function(e){return function(t){var i,r,s;if(!0===a&&(r=e?t.changedTouches[0].clientX:t.clientX,s=e?t.changedTouches[0].clientY:t.clientY,i=n.mouseSensitivity,C=(u-r)*i+c,I=(s-l)*i+o,n.debug.lonlat))return console.log("longitude: ",C,"latitude: ",I)}},t=function(e){return a=!1},s=r(!1),g=i(!1),d=t,(m=b(e)).on("mousedown",s,!1).on("mousemove",g,!1).on("mouseup",d,!1),h=r(!0),w=i(!0),M=t,m.on("touchstart",h,!1).on("touchmove",w,!1).on("touchend",M,!1)},s=function(e){return null==e&&(e=document),function(){return e.fullscreenElement||e.webkitFullscreenElement||e.mozFullScreenElement||e.msFullscreenElement}},a=s(),L=function(){var e,n;return document.exitFullscreen?(e=function(){return document.exitFullscreen()},n=function(e){return e.requestFullscreen()}):document.msExitFullscreen?(e=function(){return document.msExitFullscreen()},n=function(e){return e.msRequestFullscreen()}):document.mozCancelFullScreen?(e=function(){return document.mozCancelFullScreen()},n=function(e){return e.mozRequestFullscreen()}):document.webkitExitFullscreen?(e=function(){return document.webkitExitFullscreen()},n=function(e){return e.webkitRequestFullscreen()}):n=e=function(){return console.log("The bowser doesn't support fullscreen mode")},{request:n,exit:e}},y=function(){var e,n,t;return n=L(),t=n.request,e=n.exit,function(n){return a()?e():t(n)}}(),o=function(e){var n,t,i;return t=a(),n="fullscreen-mode",i=b(e),null!=t?(i.addClass(n),e.style.width="100vw",e.style.height="100vh",e.style["max-width"]="unset",e.style["max-height"]="unset"):(i.removeClass(n),e.style.width=null,e.style.height=null,e.style["max-width"]=null,e.style["max-height"]=null),x()},M=function(e){var n,t,i;return n=document.createElement("div"),n.className="3panorama-controls",n.style.position="absolute",n.style.bottom=0,n.style.width="100%",n.style.height="3.5em",n.style["min-height"]="32px",t=document.createElement("img"),i=b(t),t.src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCAzMjAgMzIwIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAzMjAgMzIwOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjI0cHgiIGhlaWdodD0iMjRweCI+CjxnIGlkPSJYTUxJRF8xMDVfIj4KCTxnPgoJCTxnPgoJCQk8cG9seWdvbiBwb2ludHM9IjEyNS4wMDcsMTgwLjg0OSAyMCwyODUuODU3IDIwLDIwMy40MDEgMCwyMDMuNDAxIDAsMzIwIDExNi41OTksMzIwIDExNi41OTksMzAwIDM0LjE0MiwzMDAgMTM5LjE1LDE5NC45OTIgICAgICAgICAiIGZpbGw9IiNGRkZGRkYiLz4KCQkJPHBvbHlnb24gcG9pbnRzPSIyMDMuNDAxLDAgMjAzLjQwMSwyMCAyODUuODU1LDIwIDE4MC44NSwxMjUuMDA1IDE5NC45OTMsMTM5LjE0OCAzMDAsMzQuMTQgMzAwLDExNi41OTkgMzIwLDExNi41OTkgMzIwLDAgICAgICAgICAiIGZpbGw9IiNGRkZGRkYiLz4KCQkJPHBvbHlnb24gcG9pbnRzPSIyMCwzNC4xNDIgMTI1LjAwNiwxMzkuMTQ4IDEzOS4xNDksMTI1LjAwNiAzNC4xNDMsMjAgMTE2LjU5OSwyMCAxMTYuNTk5LDAgMCwwIDAsMTE2LjU5OSAyMCwxMTYuNTk5ICAgICIgZmlsbD0iI0ZGRkZGRiIvPgoJCQk8cG9seWdvbiBwb2ludHM9IjMwMCwyODUuODU1IDE5NC45OTQsMTgwLjg0OSAxODAuODUxLDE5NC45OTEgMjg1Ljg2LDMwMCAyMDMuNDAxLDMwMCAyMDMuNDAxLDMyMCAzMjAsMzIwIDMyMCwyMDMuNDAxICAgICAgMzAwLDIwMy40MDEgICAgIiBmaWxsPSIjRkZGRkZGIi8+CgkJPC9nPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=",t.style.margin="0.3em",t.style.height="75%",t.style["min-height"]="24px",i.on("click",function(){return y(e)},!1),b(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange msfullscreenchange",function(){return o(e)}),n.appendChild(t),e.appendChild(n)},x=function(e){return g(),r.aspect=p/d,r.updateProjectionMatrix(),A.setSize(p,d)},E=m(),r=E.camera,f=E.mesh,v=E.scene,A=E.renderer,t=function(){requestAnimationFrame(t),z()},z=function(){return T(),A.render(v,r)},T=function(){var e,t,i,o,c,u;return I=Math.max(-85,Math.min(85,I)),e=THREE.Math.degToRad(90-I),i=THREE.Math.degToRad(C),t=n.sphere.radius,o=t*Math.sin(e)*Math.cos(i),c=t*Math.cos(e),u=t*Math.sin(e)*Math.sin(i),r.lookAt(new THREE.Vector3(o,c,u))},t(),u=n.debug,{container:c,camera:r,mesh:f,scene:v,renderer:A,debugSettings:u,util:b}}}).call(this);