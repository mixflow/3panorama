/*
 * A panorama viewer base on three.js.
 * Panarama is a type of image which can be watched in 360 degree horizonally and 180 degree vertically.
 *
 * @license Apache 2.0
 * @author MixFlow
 * @date 2017-08
 */
(function(){window.threePanorama=function(e){var n,t,i,c,o,r,u,l,s,a,d,g,m,M,w,h,I,C,E,L,x,D,A,v,T,y,b;u={container:document.body,image:void 0,fov:65,useWindowSize:!1,alternateRatio:16/9,enableDragNewImage:!0,mouseSensitivity:.1,lonlat:[0,0],sphere:{radius:500},debug:{imageLoadProgress:!1,lonlat:!1}},e=e||{};for(w in u)y=u[w],w in e||(e[w]=y);if(null==e.image)throw{type:"No image provided.",msg:"Please fill panorama image path(string) in the parameter 'image' of settings"};return o="string"==typeof e.container?document.querySelectorAll(e.container)[0]:e.container,I=e.lonlat[0],h=e.lonlat[1],b=0,d=0,(a=function(){var n;if(e.useWindowSize?b=window.innerWidth:(n=o.getBoundingClientRect(),b=n.width,d=n.height),!b&&!d)throw{type:"Lack of Viewer Size.",msg:"Viewer width and height are both missing(value is 0), Please check the container size(width and height > 0). Or use window size to set Viewer size by setting `useWindowSize` as `true`"};return d?b||(b=d*e.alternateRatio):d=b/e.alternateRatio,{width:b,height:d}})(),g=function(){var n,i,c,r,u,l,s;return n=new THREE.PerspectiveCamera(e.fov,b/d,1,1100),n.target=new THREE.Vector3(0,0,0),(i=new THREE.SphereBufferGeometry(e.sphere.radius,50,50)).scale(-1,1,1),s=(new THREE.TextureLoader).load(e.image),c=new THREE.MeshBasicMaterial({map:s}),r=new THREE.Mesh(i,c),(l=new THREE.Scene).add(r),u=M(),o.appendChild(u.domElement),t(u.domElement),m(o),window.addEventListener("resize",E,!1),{camera:n,mesh:r,scene:l,renderer:u}},M=function(){var e;return(e=new THREE.WebGLRenderer).setPixelRatio(window.devicePixelRatio),e.setSize(b,d),e},t=function(n){var t,i,c,o,r,u,l,s,a,d,g,m,M,w;return u=0,l=0,r=0,o=0,s=!1,c=function(e){return function(n){return n.preventDefault(),s=!0,u=e?n.changedTouches[0].clientX:n.clientX,l=e?n.changedTouches[0].clientY:n.clientY,r=I,o=h}},i=function(n){return function(t){var i,c,a;if(!0===s&&(c=n?t.changedTouches[0].clientX:t.clientX,a=n?t.changedTouches[0].clientY:t.clientY,i=e.mouseSensitivity,I=(u-c)*i+r,h=(a-l)*i+o,e.debug.lonlat))return console.log("longitude: ",I,"latitude: ",h)}},t=function(e){return s=!1},a=c(!1),d=i(!1),g=t,n.addEventListener("mousedown",a,!1),n.addEventListener("mousemove",d,!1),n.addEventListener("mouseup",g,!1),w=c(!0),M=i(!0),m=t,n.addEventListener("touchstart",w,!1),n.addEventListener("touchmove",M,!1),n.addEventListener("touchend",m,!1)},s=function(e){return null==e&&(e=document),function(){return e.fullscreenElement||e.webkitFullscreenElement||e.mozFullScreenElement||e.msFullscreenElement}},l=s(),A=function(e){return l()?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():console.log("The bowser doesn't support fullscreen mode"):document.documentElement.requestFullscreen?e.requestFullscreen():document.documentElement.msRequestFullscreen?e.msRequestFullscreen():document.documentElement.mozRequestFullScreen?e.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen?e.webkitRequestFullscreen():console.log("The bowser doesn't support fullscreen mode")},c=function(e){var n,t;return t=l(),n="fullscreen-mode",null!=t?(e.className+=" "+n,e.style.width="100vw",e.style.height="100vh",e.style["max-width"]="unset",e.style["max-height"]="unset"):(e.className=e.className.replace(new RegExp("(\\s|^)"+n+"(\\s|$)"),""),e.style.width=null,e.style.height=null,e.style["max-width"]=null,e.style["max-height"]=null),E()},m=function(e){var n,t;return n=document.createElement("div"),n.className="3panorama-controls",n.style.position="absolute",n.style.bottom=0,n.style.width="100%",n.style.height="3.5em",n.style["min-height"]="32px",t=document.createElement("img"),t.src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCAzMjAgMzIwIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAzMjAgMzIwOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjI0cHgiIGhlaWdodD0iMjRweCI+CjxnIGlkPSJYTUxJRF8xMDVfIj4KCTxnPgoJCTxnPgoJCQk8cG9seWdvbiBwb2ludHM9IjEyNS4wMDcsMTgwLjg0OSAyMCwyODUuODU3IDIwLDIwMy40MDEgMCwyMDMuNDAxIDAsMzIwIDExNi41OTksMzIwIDExNi41OTksMzAwIDM0LjE0MiwzMDAgMTM5LjE1LDE5NC45OTIgICAgICAgICAiIGZpbGw9IiNGRkZGRkYiLz4KCQkJPHBvbHlnb24gcG9pbnRzPSIyMDMuNDAxLDAgMjAzLjQwMSwyMCAyODUuODU1LDIwIDE4MC44NSwxMjUuMDA1IDE5NC45OTMsMTM5LjE0OCAzMDAsMzQuMTQgMzAwLDExNi41OTkgMzIwLDExNi41OTkgMzIwLDAgICAgICAgICAiIGZpbGw9IiNGRkZGRkYiLz4KCQkJPHBvbHlnb24gcG9pbnRzPSIyMCwzNC4xNDIgMTI1LjAwNiwxMzkuMTQ4IDEzOS4xNDksMTI1LjAwNiAzNC4xNDMsMjAgMTE2LjU5OSwyMCAxMTYuNTk5LDAgMCwwIDAsMTE2LjU5OSAyMCwxMTYuNTk5ICAgICIgZmlsbD0iI0ZGRkZGRiIvPgoJCQk8cG9seWdvbiBwb2ludHM9IjMwMCwyODUuODU1IDE5NC45OTQsMTgwLjg0OSAxODAuODUxLDE5NC45OTEgMjg1Ljg2LDMwMCAyMDMuNDAxLDMwMCAyMDMuNDAxLDMyMCAzMjAsMzIwIDMyMCwyMDMuNDAxICAgICAgMzAwLDIwMy40MDEgICAgIiBmaWxsPSIjRkZGRkZGIi8+CgkJPC9nPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=",t.style.margin="0.3em",t.style.height="75%",t.style["min-height"]="24px",t.addEventListener("click",function(){return A(e)},!1),document.addEventListener("webkitfullscreenchange",function(){return c(e)},!1),document.addEventListener("mozfullscreenchange ",function(){return c(e)},!1),document.addEventListener("msfullscreenchange ",function(){return c(e)},!1),document.addEventListener("fullscreenchange ",function(){return c(e)},!1),n.appendChild(t),e.appendChild(n)},E=function(e){return a(),i.aspect=b/d,i.updateProjectionMatrix(),x.setSize(b,d)},L=g(),i=L.camera,C=L.mesh,D=L.scene,x=L.renderer,n=function(){requestAnimationFrame(n),v()},v=function(){return T(),x.render(D,i)},T=function(){var n,t,c,o,r,u;return h=Math.max(-85,Math.min(85,h)),n=THREE.Math.degToRad(90-h),c=THREE.Math.degToRad(I),t=e.sphere.radius,o=t*Math.sin(n)*Math.cos(c),r=t*Math.cos(n),u=t*Math.sin(n)*Math.sin(c),i.lookAt(new THREE.Vector3(o,r,u))},n(),r=e.debug,{container:o,camera:i,mesh:C,scene:D,renderer:x,debugSettings:r}}}).call(this);