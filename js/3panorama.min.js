/*
 * A panorama viewer base on three.js.
 * Panarama is a type of image which can be watched in 360 degree horizonally and 180 degree vertically.
 *
 * @license Apache 2.0
 * @author MixFlow
 * @date 2017-08
 */
(function(){var e=[].slice;window.threePanorama=function(n){var t,r,i,o,u,a,l,c,s,d,m,h,g,w,f,M,E,v,p,y,x,T,z,D,I,N,R,S,b,C;l={container:document.body,image:void 0,fov:65,canUseWindowSize:!1,alternateRatio:16/9,canKeepInitalSize:!0,enableDragNewImage:!0,mouseSensitivity:.1,lonlat:[0,0],sphere:{radius:500},debug:{imageLoadProgress:!1,lonlat:!1,cameraSize:!1}},n=n||{};for(f in l)b=l[f],f in n||(n[f]=b);if(null==n.image)throw{type:"No image provided.",msg:"Please fill panorama image path(string) in the parameter 'image' of settings"};return u="string"==typeof n.container?document.querySelectorAll(n.container)[0]:n.container,E=n.lonlat[0],M=n.lonlat[1],C=0,m=0,y={},(d=function(e){var t;if(null==e&&(e=n.canKeepInitalSize),n.canUseWindowSize?(C=window.innerWidth,m=window.innerHeight):(t=u.getBoundingClientRect(),C=t.width,m=t.height),!C&&!m)throw{type:"Lack of Viewer Size.",msg:"Viewer width and height are both missing(value is 0), Please check the container size(width and height > 0). Or use window size to set Viewer size by setting `canUseWindowSize` as `true`"};return m?C||(C=m*n.alternateRatio):m=C/n.alternateRatio,!0===e&&(C in y?m=y[C]:y[C]=m),n.debug.cameraSize&&console.log("current camera size:",C,m),{width:C,height:m}})(),S=function(){var n,t;return n={addClass:function(e,n){return e.className+=" "+n},removeClass:function(e,n){return e.className=e.className.replace(new RegExp("(\\s|^)"+n+"(\\s|$)"),"")},on:function(e,n,t,r){var i,o,u,a,l;for(null==r&&(r=!1),l=[],u=0,a=(o=n.split(" ")).length;u<a;u++)i=o[u],l.push(e.addEventListener(i,t,r));return l}},t=function(t){var r,i,o;o=function(n){return function(){var r;return r=1<=arguments.length?e.call(arguments,0):[],n.apply(null,[t.domel].concat(e.call(r))),t}};for(i in n)r=n[i],t[i]=o(r);return t},function(e){var r;return null!=e?(r={domel:e},t(r)):n}}(),h=function(){var e,t,i,o,a,l,c;return e=new THREE.PerspectiveCamera(n.fov,C/m,1,1100),e.target=new THREE.Vector3(0,0,0),(t=new THREE.SphereBufferGeometry(n.sphere.radius,50,50)).scale(-1,1,1),c=(new THREE.TextureLoader).load(n.image),i=new THREE.MeshBasicMaterial({map:c}),o=new THREE.Mesh(t,i),(l=new THREE.Scene).add(o),a=w(),u.appendChild(a.domElement),r(a.domElement),g(u),S(window).on("resize",function(){var e;return e=void 0,function(n){return clearTimeout(e),e=setTimeout(function(){return p(n,!1)},100)}}(),!1),{camera:e,mesh:o,scene:l,renderer:a}},w=function(){var e;return(e=new THREE.WebGLRenderer).setPixelRatio(window.devicePixelRatio),e.setSize(C,m),e},r=function(e){var t,r,i,o,u,a,l,c,s,d,m,h,g,w,f;return a=0,l=0,u=0,o=0,c=!1,i=function(e){return function(n){return n.preventDefault(),c=!0,a=e?n.changedTouches[0].clientX:n.clientX,l=e?n.changedTouches[0].clientY:n.clientY,u=E,o=M}},r=function(e){return function(t){var r,i,s;if(!0===c&&(i=e?t.changedTouches[0].clientX:t.clientX,s=e?t.changedTouches[0].clientY:t.clientY,r=n.mouseSensitivity,E=(a-i)*r+u,M=(s-l)*r+o,n.debug.lonlat))return console.log("longitude: ",E,"latitude: ",M)}},t=function(e){return c=!1},s=i(!1),d=r(!1),m=t,(h=S(e)).on("mousedown",s,!1).on("mousemove",d,!1).on("mouseup",m,!1),f=i(!0),w=r(!0),g=t,h.on("touchstart",f,!1).on("touchmove",w,!1).on("touchend",g,!1)},s=function(e){return null==e&&(e=document),function(){return e.fullscreenElement||e.webkitFullscreenElement||e.mozFullScreenElement||e.msFullscreenElement}},c=s(),z=function(){var e,n;return document.exitFullscreen?(e=function(){return document.exitFullscreen()},n=function(e){return e.requestFullscreen()}):document.msExitFullscreen?(e=function(){return document.msExitFullscreen()},n=function(e){return e.msRequestFullscreen()}):document.mozCancelFullScreen?(e=function(){return document.mozCancelFullScreen()},n=function(e){return e.mozRequestFullscreen()}):document.webkitExitFullscreen?(e=function(){return document.webkitExitFullscreen()},n=function(e){return e.webkitRequestFullscreen()}):n=e=function(){return console.log("The bowser doesn't support fullscreen mode")},{request:n,exit:e}},I=function(){var e,n,t;return n=z(),t=n.request,e=n.exit,function(n){return c()?e():t(n)}}(),o=function(e){var n,t,r;return t=c(),n="fullscreen-mode",r=S(e),null!=t?(r.addClass(n),e.style.width="100vw",e.style.height="100vh",e.style["max-width"]="unset",e.style["max-height"]="unset"):(r.removeClass(n),e.style.width=null,e.style.height=null,e.style["max-width"]=null,e.style["max-height"]=null)},g=function(e){var n,t,r;return n=document.createElement("div"),n.className="3panorama-controls",n.style.position="absolute",n.style.bottom=0,n.style.width="100%",n.style.height="3.5em",n.style["min-height"]="32px",t=document.createElement("img"),r=S(t),t.src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMjAgMzIwIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiPiAgPHBhdGggZmlsbD0iIzVhOWNmYyIgZD0iTTEyNSAxODAuODVsLTEwNSAxMDVWMjAzLjRIMFYzMjBoMTE2LjZ2LTIwSDM0LjE0bDEwNS4wMS0xMDV6TTIwMy40IDB2MjBoODIuNDZMMTgwLjg1IDEyNWwxNC4xNCAxNC4xNUwzMDAgMzQuMTR2ODIuNDZoMjBWMHoiLz4gIDxwYXRoIGZpbGw9IiNGRkYiIGQ9Ik0yMCAzNC4xNGwxMDUgMTA1IDE0LjE1LTE0LjEzTDM0LjE1IDIwaDgyLjQ1VjBIMHYxMTYuNmgyMHpNMzAwIDI4NS44NkwxOTUgMTgwLjg1bC0xNC4xNSAxNC4xNEwyODUuODYgMzAwSDIwMy40djIwSDMyMFYyMDMuNGgtMjB6Ii8+PC9zdmc+",t.style.margin="0.3em",t.style.height="75%",t.style["min-height"]="24px",r.on("click",function(){return I(e)},!1),S(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange msfullscreenchange",function(){return o(e)}),n.appendChild(t),e.appendChild(n)},function(){var e;return e=function(){var e,n;return e=void 0,n=void 0,function(t){var r,i;return r=t.alpha,i=t.beta,null!=e&&(E+=r-e,M+=i-n),e=r,n=i}}(),S().on(window,"deviceorientation",e,!0)}(),p=function(e,n){return null==n&&(n=!0),d(n),i.aspect=C/m,i.updateProjectionMatrix(),T.setSize(C,m)},x=h(),i=x.camera,v=x.mesh,D=x.scene,T=x.renderer,t=function(){requestAnimationFrame(t),N()},N=function(){return R(),T.render(D,i)},R=function(){var e,t,r,o,u,a;return M=Math.max(-85,Math.min(85,M)),e=THREE.Math.degToRad(90-M),r=THREE.Math.degToRad(E),t=n.sphere.radius,o=t*Math.sin(e)*Math.cos(r),u=t*Math.cos(e),a=t*Math.sin(e)*Math.sin(r),i.lookAt(new THREE.Vector3(o,u,a))},t(),a=n.debug,{container:u,camera:i,mesh:v,scene:D,renderer:T,debugSettings:a,util:S}}}).call(this);