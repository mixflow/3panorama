/*
 * A panorama viewer base on three.js.
 * Panarama is a type of image which can be watched in 360 degree horizonally and 180 degree vertically.
 *
 * @license Apache 2.0
 * @author MixFlow
 * @date 2017-08
 */
(function(){var e=[].slice;window.threePanorama=function(n){var t,i,r,o,u,a,l,c,s,d,m,g,M,h,w,f,v,E,A,I,D,p,T,z,y,C,N,x,b,L;l={container:document.body,image:void 0,fov:65,canUseWindowSize:!1,alternateRatio:16/9,canKeepInitalSize:!0,enableDragNewImage:!0,mouseSensitivity:.1,enableDeviceOrientation:!0,lonlat:[0,0],sphere:{radius:500},debug:{imageLoadProgress:!1,lonlat:!1,cameraSize:!1}},n=n||{};for(w in l)b=l[w],w in n||(n[w]=b);if(null==n.image)throw{type:"No image provided.",msg:"Please fill panorama image path(string) in the parameter 'image' of settings"};return u="string"==typeof n.container?document.querySelectorAll(n.container)[0]:n.container,v=n.lonlat[0],f=n.lonlat[1],L=0,m=0,I={},(d=function(e){var t;if(null==e&&(e=n.canKeepInitalSize),n.canUseWindowSize?(L=window.innerWidth,m=window.innerHeight):(t=u.getBoundingClientRect(),L=t.width,m=t.height),!L&&!m)throw{type:"Lack of Viewer Size.",msg:"Viewer width and height are both missing(value is 0), Please check the container size(width and height > 0). Or use window size to set Viewer size by setting `canUseWindowSize` as `true`"};return m?L||(L=m*n.alternateRatio):m=L/n.alternateRatio,!0===e&&(L in I?m=I[L]:I[L]=m),n.debug.cameraSize&&console.log("current camera size:",L,m),{width:L,height:m}})(),x=function(){var n,t;return n={addClass:function(e,n){return e.className+=" "+n},removeClass:function(e,n){return e.className=e.className.replace(new RegExp("(\\s|^)"+n+"(\\s|$)"),"")},getAttribute:function(e,n){return e.getAttribute(n)},setAttributes:function(e,n){var t;t=[];for(w in n)b=n[w],t.push(e.setAttribute(w,b));return t},css:function(e,n){var t,i,r;i=[];for(t in n)r=n[t],i.push(e.style[t]=r);return i},on:function(e,n,t,i){var r,o,u,a,l;for(null==i&&(i=!1),l=[],u=0,a=(o=n.split(" ")).length;u<a;u++)r=o[u],l.push(e.addEventListener(r,t,i));return l},off:function(e,n,t,i){var r,o,u,a,l;for(null==i&&(i=!1),l=[],u=0,a=(o=n.split(" ")).length;u<a;u++)r=o[u],l.push(e.removeEventListener(r,t,i));return l}},t=function(t){var i,r,o;o=function(n){return function(){var i;return i=1<=arguments.length?e.call(arguments,0):[],n.apply(null,[t.domel].concat(e.call(i))),t}};for(r in n)i=n[r],t[r]=o(i);return t},function(e){var i;return null!=e?(i={domel:e},t(i)):n}}(),g=function(){var e,t,r,o,a,l,c;return e=new THREE.PerspectiveCamera(n.fov,L/m,1,1100),e.target=new THREE.Vector3(0,0,0),(t=new THREE.SphereBufferGeometry(n.sphere.radius,50,50)).scale(-1,1,1),c=(new THREE.TextureLoader).load(n.image),r=new THREE.MeshBasicMaterial({map:c}),o=new THREE.Mesh(t,r),(l=new THREE.Scene).add(o),a=h(),u.appendChild(a.domElement),i(a.domElement),M(u),x(window).on("resize",function(){var e;return e=void 0,function(n){return clearTimeout(e),e=setTimeout(function(){return A(n,!1)},100)}}(),!1),{camera:e,mesh:o,scene:l,renderer:a}},h=function(){var e;return(e=new THREE.WebGLRenderer).setPixelRatio(window.devicePixelRatio),e.setSize(L,m),e},i=function(e){var t,i,r,o,u,a,l,c,s,d,m,g,M,h,w;return a=0,l=0,u=0,o=0,c=!1,r=function(e){return function(n){return n.preventDefault(),c=!0,a=e?n.changedTouches[0].clientX:n.clientX,l=e?n.changedTouches[0].clientY:n.clientY,u=v,o=f}},i=function(e){return function(t){var i,r,s;if(!0===c&&(r=e?t.changedTouches[0].clientX:t.clientX,s=e?t.changedTouches[0].clientY:t.clientY,i=n.mouseSensitivity,v=(a-r)*i+u,f=(s-l)*i+o,n.debug.lonlat))return console.log("longitude: ",v,"latitude: ",f)}},t=function(e){return c=!1},s=r(!1),d=i(!1),m=t,(g=x(e)).on("mousedown",s,!1).on("mousemove",d,!1).on("mouseup",m,!1),w=r(!0),h=i(!0),M=t,g.on("touchstart",w,!1).on("touchmove",h,!1).on("touchend",M,!1)},s=function(e){return null==e&&(e=document),function(){return e.fullscreenElement||e.webkitFullscreenElement||e.mozFullScreenElement||e.msFullscreenElement}},c=s(),T=function(){var e,n;return document.exitFullscreen?(e=function(){return document.exitFullscreen()},n=function(e){return e.requestFullscreen()}):document.msExitFullscreen?(e=function(){return document.msExitFullscreen()},n=function(e){return e.msRequestFullscreen()}):document.mozCancelFullScreen?(e=function(){return document.mozCancelFullScreen()},n=function(e){return e.mozRequestFullscreen()}):document.webkitExitFullscreen?(e=function(){return document.webkitExitFullscreen()},n=function(e){return e.webkitRequestFullscreen()}):n=e=function(){return console.log("The bowser doesn't support fullscreen mode")},{request:n,exit:e}},y=function(){var e,n,t;return n=T(),t=n.request,e=n.exit,function(n){return c()?e():t(n)}}(),o=function(e){var n,t,i;return t=c(),n="fullscreen-mode",i=x(e),null!=t?(i.addClass(n),e.style.width="100vw",e.style.height="100vh",e.style["max-width"]="unset",e.style["max-height"]="unset"):(i.removeClass(n),e.style.width=null,e.style.height=null,e.style["max-width"]=null,e.style["max-height"]=null)},M=function(e){var t,i,r,u,a,l;return t=document.createElement("div"),t.className="3panorama-controls",t.style.position="absolute",t.style.bottom=0,t.style.width="100%",t.style.height="3.5em",t.style["min-height"]="32px",u={height:"75%","min-height":"24px",padding:"0.3em"},i=document.createElement("img"),r=x(i),i.src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMjAgMzIwIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiPiAgPHBhdGggZmlsbD0iIzVhOWNmYyIgZD0iTTEyNSAxODAuODVsLTEwNSAxMDVWMjAzLjRIMFYzMjBoMTE2LjZ2LTIwSDM0LjE0bDEwNS4wMS0xMDV6TTIwMy40IDB2MjBoODIuNDZMMTgwLjg1IDEyNWwxNC4xNCAxNC4xNUwzMDAgMzQuMTR2ODIuNDZoMjBWMHoiLz4gIDxwYXRoIGZpbGw9IiNGRkYiIGQ9Ik0yMCAzNC4xNGwxMDUgMTA1IDE0LjE1LTE0LjEzTDM0LjE1IDIwaDgyLjQ1VjBIMHYxMTYuNmgyMHpNMzAwIDI4NS44NkwxOTUgMTgwLjg1bC0xNC4xNSAxNC4xNEwyODUuODYgMzAwSDIwMy40djIwSDMyMFYyMDMuNGgtMjB6Ii8+PC9zdmc+",r.css(u),r.on("click",function(){return y(e)},!1),x(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange msfullscreenchange",function(){return o(e)}),t.appendChild(i),a=function(){var e,n,i,r;return i=document.createElement("div"),(e=x(i)).addClass("3panorama-setting-pannel"),e.css({visibility:"hidden",display:"inline",position:"relative",background:"#FFF",bottom:"100%",left:"-24px",padding:"0.4em 0.8em"}),n=document.createElement("img"),n.src="data:image/svg+xml;base64,PHN2ZyBiYXNlUHJvZmlsZT0iZnVsbCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+ICA8cGF0aCBkPSJNNDAgODQuNThsNCAxMy4wNGgxMmw0LTEzLjA0YTMwIDMwIDAgMCAwIDE0Ljk1LTguNjNsMTMuMyAzLjA2IDYtMTAuNC05LjMtOS45OGEzMCAzMCAwIDAgMCAwLTE3LjI2bDkuMy05Ljk5LTYtMTAuMzktMTMuMyAzLjA2QTMwIDMwIDAgMCAwIDYwIDE1LjQyTDU2IDIuMzhINDRsLTQgMTMuMDRhMzAgMzAgMCAwIDAtMTQuOTUgOC42M2wtMTMuMy0zLjA2LTYgMTAuNCA5LjMgOS45OGEzMCAzMCAwIDAgMCAwIDE3LjI2bC05LjMgOS45OSA2IDEwLjM5IDEzLjMtMy4wNkEzMCAzMCAwIDAgMCA0MCA4NC41OHpNMzUgNTBhMTUgMTUgMCAxIDEgMzAgMCAxNSAxNSAwIDEgMS0zMCAwIiBmaWxsPSIjZmZmIiBzdHJva2U9IiM1YTljZmMiIHN0cm9rZS13aWR0aD0iNSIvPjwvc3ZnPg==",(r=x(n)).css(u),r.on("click",function(){var n,t;return t="hidden",n="visible",function(){var i;return e.css({visibility:n}),i=[n,t],t=i[0],n=i[1],i}}(),!1),t.appendChild(n),t.appendChild(i),{setting:n,settingPanel:i}}(),a._,l=a.settingPanel,function(){var e,t,i;t=document.createElement("div"),i=x(t),t.innerText="Enable Sensor: ",i.css({display:"inline",color:"#000","font-size":"1em","font-weight":"bold"}),e=document.createElement("span"),x(e).css({"font-weight":"normal"}),"ON","OFF",e.innerText=n.enableDeviceOrientation?"ON":"OFF",t.appendChild(e),i.on("click",function(){return n.enableDeviceOrientation=!n.enableDeviceOrientation,n.enableDeviceOrientation?e.innerText="ON":e.innerText="OFF"},!1),l.appendChild(t)}(),e.appendChild(t)},function(){var e;return e=function(){var e,t;return e=void 0,t=void 0,function(i){var r,o;return n.enableDeviceOrientation?(r=i.alpha,o=i.beta,null!=e&&(v+=r-e,f+=o-t),e=r,t=o):(e=void 0,t=void 0)}}(),x().on(window,"deviceorientation",e,!0)}(),A=function(e,n){return null==n&&(n=!0),d(n),r.aspect=L/m,r.updateProjectionMatrix(),p.setSize(L,m)},D=g(),r=D.camera,E=D.mesh,z=D.scene,p=D.renderer,t=function(){requestAnimationFrame(t),C()},C=function(){return N(),p.render(z,r)},N=function(){var e,t,i,o,u,a;return f=Math.max(-85,Math.min(85,f)),e=THREE.Math.degToRad(90-f),i=THREE.Math.degToRad(v),t=n.sphere.radius,o=t*Math.sin(e)*Math.cos(i),u=t*Math.cos(e),a=t*Math.sin(e)*Math.sin(i),r.lookAt(new THREE.Vector3(o,u,a))},t(),a=n.debug,{container:u,camera:r,mesh:E,scene:z,renderer:p,debugSettings:a,util:x}}}).call(this);